<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Yatzy - Real-Time</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .connection-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
            transition: background 0.3s;
        }

        .status-dot.connected {
            background: #2ed573;
        }

        .connection-setup {
            padding: 30px;
            text-align: center;
        }

        .setup-options {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .option-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-width: 250px;
            transition: transform 0.2s;
        }

        .option-card:hover {
            transform: translateY(-5px);
        }

        .option-card h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group input {
            padding: 12px 16px;
            margin: 5px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            max-width: 200px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .connection-status {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .room-code {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            letter-spacing: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .room-code:hover {
            background: #e9ecef;
        }

        .room-code::after {
            content: " 📋";
            font-size: 1rem;
            opacity: 0.7;
        }

        .players-list {
            background: #f1f3f4;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
        }

        .players-list h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .player-item {
            padding: 8px;
            background: white;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .player-item.disconnected {
            background: #ffebee;
            opacity: 0.7;
        }

        .player-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
        }

        .status-host {
            background: #ff6b6b;
        }

        .status-connected {
            background: #00b894;
        }

        .status-you {
            background: #667eea;
        }

        .game-area {
            display: none;
            padding: 20px;
        }

        .current-player {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .current-player.your-turn {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .dice-area {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .die {
            width: 60px;
            height: 60px;
            border: 3px solid #333;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
            position: relative;
        }

        .die:hover:not(.disabled) {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .die.held {
            background: #ff6b6b;
            color: white;
            border-color: #e55353;
        }

        .die.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .die.rolling {
            animation: roll 0.5s ease-in-out;
        }

        @keyframes roll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }

        .roll-info {
            margin: 15px 0;
            font-size: 1.1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .scoreboard {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .player-score {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
        }

        .player-score.current-turn {
            border: 3px solid #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            transform: scale(1.02);
        }

        .player-score.your-score {
            border: 3px solid #00b894;
            box-shadow: 0 0 20px rgba(0, 184, 148, 0.3);
        }

        .player-score h3 {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
            position: relative;
        }

        .player-score.disconnected h3 {
            background: linear-gradient(135deg, #636e72, #2d3436);
        }

        .score-categories {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 5px;
            font-size: 14px;
        }

        .category-name {
            padding: 8px;
            background: #e9ecef;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .category-name:hover {
            background: #dee2e6;
        }

        .category-name.available {
            background: #d4edda;
            border: 2px solid #28a745;
            animation: glow 2s ease-in-out infinite alternate;
        }

        .category-name.available:hover {
            background: #c3e6cb;
            transform: translateX(5px);
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(40, 167, 69, 0.5); }
            to { box-shadow: 0 0 15px rgba(40, 167, 69, 0.8); }
        }

        .category-score {
            padding: 8px;
            text-align: center;
            background: #f8f9fa;
            border-radius: 5px;
            font-weight: bold;
        }

        .section-header {
            grid-column: 1 / -1;
            background: #6c757d;
            color: white;
            padding: 5px;
            text-align: center;
            font-weight: bold;
            border-radius: 5px;
            margin-top: 10px;
        }

        .total-row {
            grid-column: 1 / -1;
            background: #007bff;
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            border-radius: 5px;
            margin-top: 5px;
        }

        .game-over {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border-radius: 10px;
            margin: 20px 0;
        }

        .winner {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .final-scores {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #ffcdd2;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #c8e6c9;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #333;
            color: white;
            border-radius: 8px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.info {
            background: #17a2b8;
        }

        @media (max-width: 768px) {
            .setup-options {
                flex-direction: column;
                align-items: center;
            }
            
            .dice-container {
                gap: 10px;
            }
            
            .die {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .room-code {
                font-size: 1.5rem;
                letter-spacing: 2px;
            }
            
            .connection-indicator {
                position: static;
                margin-top: 10px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎲 Multiplayer Yatzy 🎲</h1>
            <p>Real-time multiplayer dice game</p>
            <div class="connection-indicator">
                <div class="status-dot" id="connectionDot"></div>
                <span id="connectionStatus">Connecting...</span>
            </div>
        </div>

        <div id="connectionSetup" class="connection-setup">
            <h2>Choose Your Game Mode</h2>
            
            <div class="setup-options">
                <div class="option-card">
                    <h3>🏠 Host a Game</h3>
                    <p>Create a new game room for others to join</p>
                    <div class="input-group">
                        <input type="text" id="hostPlayerName" placeholder="Your Name" value="">
                    </div>
                    <button class="btn" id="hostBtn" onclick="hostGame()">Create Room</button>
                </div>
                
                <div class="option-card">
                    <h3>🔗 Join a Game</h3>
                    <p>Enter a room code to join an existing game</p>
                    <div class="input-group">
                        <input type="text" id="joinPlayerName" placeholder="Your Name" value="">
                        <input type="text" id="roomCode" placeholder="Room Code" maxlength="6" style="text-transform: uppercase;">
                    </div>
                    <button class="btn btn-secondary" id="joinBtn" onclick="joinGame()">Join Room</button>
                </div>
            </div>
            
            <div id="connectionStatus" class="connection-status" style="display: none;">
                <h3>Connection Status</h3>
                <div id="statusContent"></div>
                <div id="playersList" class="players-list" style="display: none;"></div>
                <div id="errorMessage" class="error-message" style="display: none;"></div>
                <button id="startGameBtn" class="btn" onclick="startMultiplayerGame()" style="display: none;">Start Game</button>
            </div>
        </div>

        <div id="gameArea" class="game-area">
            <div id="currentPlayer" class="current-player"></div>
            
            <div class="dice-area">
                <div class="dice-container" id="diceContainer"></div>
                <div class="roll-info">
                    <span id="rollsLeft">Rolls left: 3</span>
                    <span id="gameInstructions"></span>
                </div>
                <button id="rollBtn" class="btn" onclick="rollDice()">Roll Dice</button>
            </div>

            <div id="scoreboard" class="scoreboard"></div>
            
            <div id="gameOver" class="game-over" style="display: none;">
                <div class="winner" id="winner"></div>
                <div class="final-scores" id="finalScores"></div>
                <button class="btn" onclick="resetGame()">New Game</button>
            </div>
        </div>
    </div>

    <!-- Notification container -->
    <div id="notification" class="notification"></div>

    <!-- Socket.io CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    
    <script>
        class RealTimeYatzy {
            constructor() {
                // Configuration
                this.serverUrl = window.location.hostname === 'localhost' 
                    ? 'http://localhost:3000' 
                    : 'https://yatzy-backend-production.up.railway.app'; // Replace with your Railway URL
                
                // Game state
                this.socket = null;
                this.connected = false;
                this.playerId = null;
                this.roomCode = null;
                this.isHost = false;
                this.isMyTurn = false;
                
                this.players = [];
                this.gameState = {
                    gameStarted: false,
                    currentPlayerIndex: 0,
                    dice: [1, 1, 1, 1, 1],
                    heldDice: [false, false, false, false, false],
                    rollsLeft: 3
                };
                
                this.categories = {
                    ones: { name: "Ones", type: "number", number: 1 },
                    twos: { name: "Twos", type: "number", number: 2 },
                    threes: { name: "Threes", type: "number", number: 3 },
                    fours: { name: "Fours", type: "number", number: 4 },
                    fives: { name: "Fives", type: "number", number: 5 },
                    sixes: { name: "Sixes", type: "number", number: 6 },
                    threeOfKind: { name: "Three of a Kind", type: "special" },
                    fourOfKind: { name: "Four of a Kind", type: "special" },
                    fullHouse: { name: "Full House", type: "special" },
                    smallStraight: { name: "Small Straight", type: "special" },
                    largeStraight: { name: "Large Straight", type: "special" },
                    yatzy: { name: "Yatzy", type: "special" },
                    chance: { name: "Chance", type: "special" }
                };
                
                this.initializeConnection();
                this.setupEventListeners();
            }

            initializeConnection() {
                try {
                    this.socket = io(this.serverUrl, {
                        transports: ['websocket', 'polling'],
                        upgrade: true,
                        rememberUpgrade: true
                    });
                    
                    this.setupSocketListeners();
                } catch (error) {
                    console.error('Connection initialization failed:', error);
                    this.updateConnectionStatus('Connection Failed', false);
                }
            }

            setupSocketListeners() {
                // Connection events
                this.socket.on('connect', () => {
                    console.log('Connected to server');
                    this.connected = true;
                    this.updateConnectionStatus('Connected', true);
                    this.attemptReconnect();
                });

                this.socket.on('disconnect', (reason) => {
                    console.log('Disconnected:', reason);
                    this.connected = false;
                    this.updateConnectionStatus('Disconnected', false);
                    this.showNotification('Connection lost. Attempting to reconnect...', 'error');
                });

                this.socket.on('connect_error', (error) => {
                    console.error('Connection error:', error);
                    this.updateConnectionStatus('Connection Error', false);
                });

                // Room events
                this.socket.on('room-created', (data) => {
                    if (data.success) {
                        this.playerId = data.playerId;
                        this.roomCode = data.roomCode;
                        this.isHost = true;
                        this.showRoomCreated(data.roomCode);
                        this.showNotification('Room created successfully!', 'success');
                    } else {
                        this.showError(data.error);
                    }
                });

                this.socket.on('join-result', (data) => {
                    if (data.success) {
                        this.playerId = data.playerId;
                        this.roomCode = data.roomCode;
                        this.isHost = false;
                        this.showRoomJoined();
                        this.showNotification('Joined room successfully!', 'success');
                    } else {
                        this.showError(data.error);
                    }
                });

                this.socket.on('players-updated', (players) => {
                    this.players = players;
                    this.updatePlayersList();
                });

                this.socket.on('player-joined', (data) => {
                    this.showNotification(`${data.player.name} joined the game`, 'info');
                });

                this.socket.on('player-disconnected', (data) => {
                    this.showNotification(`${data.playerName} disconnected`, 'info');
                    this.updatePlayersList();
                });

                this.socket.on('player-reconnected', (data) => {
                    this.showNotification(`${data.playerName} reconnected`, 'success');
                    this.updatePlayersList();
                });

                this.socket.on('host-changed', (data) => {
                    if (data.newHostId === this.playerId) {
                        this.isHost = true;
                        this.showNotification('You are now the host!', 'info');
                    } else {
                        this.showNotification(`${data.newHostName} is now the host`, 'info');
                    }
                    this.updatePlayersList();
                });

                // Game events
                this.socket.on('game-started', (gameState) => {
                    this.gameState = gameState;
                    this.startGame(gameState);
                    this.showNotification('Game started!', 'success');
                });

                this.socket.on('dice-rolled', (data) => {
                    this.gameState.dice = data.dice;
                    this.gameState.rollsLeft = data.rollsLeft;
                    this.updateGameDisplay();
                    this.animateDiceRoll();
                });

                this.socket.on('dice-hold-updated', (data) => {
                    this.gameState.heldDice = data.heldDice;
                    this.updateGameDisplay();
                });

                this.socket.on('game-updated', (data) => {
                    this.gameState.currentPlayerIndex = data.currentPlayerIndex;
                    this.gameState.rollsLeft = data.rollsLeft;
                    this.gameState.dice = data.dice;
                    this.gameState.heldDice = data.heldDice;
                    this.players = data.players;
                    this.updateGameDisplay();
                });

                this.socket.on('game-completed', (data) => {
                    this.endGame(data.winner, data.finalScores);
                });

                // Error handling
                this.socket.on('start-game-result', (data) => {
                    if (!data.success) {
                        this.showError(data.error);
                    }
                });

                this.socket.on('reconnect-result', (data) => {
                    if (data.success) {
                        this.gameState = data.gameState;
                        this.players = data.gameState.players;
                        if (data.gameState.gameStarted) {
                            this.showGameArea();
                            this.updateGameDisplay();
                        }
                        this.showNotification('Reconnected successfully!', 'success');
                    } else {
                        this.showError('Reconnection failed: ' + data.error);
                    }
                });
            }

            setupEventListeners() {
                // Enter key support
                document.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const activeElement = document.activeElement;
                        if (activeElement.id === 'hostPlayerName') {
                            this.hostGame();
                        } else if (activeElement.id === 'joinPlayerName' || activeElement.id === 'roomCode') {
                            this.joinGame();
                        }
                    }
                });

                // Room code auto-uppercase
                const roomCodeInput = document.getElementById('roomCode');
                if (roomCodeInput) {
                    roomCodeInput.addEventListener('input', (e) => {
                        e.target.value = e.target.value.toUpperCase();
                    });
                }

                // Keyboard shortcuts for game
                document.addEventListener('keydown', (e) => {
                    if (this.gameState.gameStarted && this.isMyTurn) {
                        // Space to roll dice
                        if (e.code === 'Space' && !document.getElementById('rollBtn').disabled) {
                            e.preventDefault();
                            this.rollDice();
                        }
                        
                        // Number keys 1-5 to toggle dice hold
                        if (e.code >= 'Digit1' && e.code <= 'Digit5') {
                            const diceIndex = parseInt(e.code.slice(-1)) - 1;
                            if (diceIndex < 5) {
                                this.toggleHold(diceIndex);
                            }
                        }
                    }
                });

                // Page visibility for reconnection
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && !this.connected && this.playerId) {
                        this.attemptReconnect();
                    }
                });
            }

            updateConnectionStatus(status, connected) {
                const statusEl = document.getElementById('connectionStatus');
                const dotEl = document.getElementById('connectionDot');
                
                statusEl.textContent = status;
                dotEl.className = connected ? 'status-dot connected' : 'status-dot';
                this.connected = connected;
            }

            attemptReconnect() {
                if (this.playerId && this.roomCode) {
                    this.socket.emit('reconnect-player', {
                        playerId: this.playerId,
                        roomCode: this.roomCode
                    });
                }
            }

            hostGame() {
                const playerName = document.getElementById('hostPlayerName').value.trim();
                if (!playerName) {
                    this.showError('Please enter your name');
                    return;
                }

                const hostBtn = document.getElementById('hostBtn');
                hostBtn.disabled = true;
                hostBtn.classList.add('btn-loading');

                this.socket.emit('create-room', { playerName });
            }

            joinGame() {
                const playerName = document.getElementById('joinPlayerName').value.trim();
                const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
                
                if (!playerName || !roomCode) {
                    this.showError('Please enter your name and room code');
                    return;
                }

                const joinBtn = document.getElementById('joinBtn');
                joinBtn.disabled = true;
                joinBtn.classList.add('btn-loading');

                this.socket.emit('join-room', { roomCode, playerName });
            }

            showRoomCreated(roomCode) {
                document.getElementById('connectionStatus').style.display = 'block';
                document.getElementById('statusContent').innerHTML = `
                    <h4>Room Created!</h4>
                    <p>Share this code with friends:</p>
                    <div class="room-code" onclick="copyToClipboard('${roomCode}')" title="Click to copy">
                        ${roomCode}
                    </div>
                    <p>Waiting for players to join...</p>
                `;
                this.enableHostControls();
            }

            showRoomJoined() {
                document.getElementById('connectionStatus').style.display = 'block';
                document.getElementById('statusContent').innerHTML = `
                    <h4>Joined Room!</h4>
                    <p>Waiting for host to start the game...</p>
                `;
            }

            enableHostControls() {
                document.getElementById('startGameBtn').style.display = 'inline-block';
            }

            updatePlayersList() {
                const playersListDiv = document.getElementById('playersList');
                playersListDiv.style.display = 'block';
                
                let html = '<h4>Players in Room:</h4>';
                this.players.forEach(player => {
                    let statusClass = 'status-connected';
                    let statusText = 'PLAYER';
                    
                    if (player.isHost) {
                        statusClass = 'status-host';
                        statusText = 'HOST';
                    } else if (player.id === this.playerId) {
                        statusClass = 'status-you';
                        statusText = 'YOU';
                    }
                    
                    html += `
                        <div class="player-item ${!player.connected ? 'disconnected' : ''}">
                            <span>${player.name} ${!player.connected ? '(disconnected)' : ''}</span>
                            <span class="player-status ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                    `;
                });
                
                playersListDiv.innerHTML = html;
                
                // Show start button only for host with 2+ players
                if (this.isHost) {
                    const startBtn = document.getElementById('startGameBtn');
                    startBtn.style.display = this.players.length >= 2 ? 'inline-block' : 'none';
                }
            }

            startMultiplayerGame() {
                if (this.players.length < 2) {
                    this.showError('Need at least 2 players to start');
                    return;
                }

                this.socket.emit('start-game', { roomCode: this.roomCode });
            }

            startGame(gameState) {
                this.gameState = gameState;
                this.players = gameState.players;
                this.showGameArea();
                this.updateGameDisplay();
            }

            showGameArea() {
                document.getElementById('connectionSetup').style.display = 'none';
                document.getElementById('gameArea').style.display = 'block';
            }

            rollDice() {
                if (!this.isMyTurn || this.gameState.rollsLeft <= 0) {
                    return;
                }

                this.socket.emit('roll-dice', { roomCode: this.roomCode });
                
                // Disable roll button temporarily
                const rollBtn = document.getElementById('rollBtn');
                rollBtn.disabled = true;
                setTimeout(() => rollBtn.disabled = false, 1000);
            }

            toggleHold(index) {
                if (!this.isMyTurn || this.gameState.rollsLeft === 3) {
                    return;
                }

                this.socket.emit('toggle-hold', { 
                    roomCode: this.roomCode, 
                    diceIndex: index 
                });
            }

            scoreCategory(category) {
                if (!this.isMyTurn || this.gameState.rollsLeft === 3) {
                    return;
                }

                this.socket.emit('score-category', { 
                    roomCode: this.roomCode, 
                    category 
                });
            }

            calculateScore(category, dice) {
                const counts = [0, 0, 0, 0, 0, 0, 0];
                dice.forEach(die => counts[die]++);
                
                switch (category) {
                    case 'ones': case 'twos': case 'threes': case 'fours': case 'fives': case 'sixes':
                        const num = this.categories[category].number;
                        return counts[num] * num;
                    
                    case 'threeOfKind':
                        return counts.some(count => count >= 3) ? dice.reduce((a, b) => a + b, 0) : 0;
                    
                    case 'fourOfKind':
                        return counts.some(count => count >= 4) ? dice.reduce((a, b) => a + b, 0) : 0;
                    
                    case 'fullHouse':
                        const hasThree = counts.some(count => count === 3);
                        const hasTwo = counts.some(count => count === 2);
                        return (hasThree && hasTwo) ? 25 : 0;
                    
                    case 'smallStraight':
                        const smallStraights = [[1,2,3,4], [2,3,4,5], [3,4,5,6]];
                        const diceSet = new Set(dice);
                        return smallStraights.some(straight => 
                            straight.every(num => diceSet.has(num))
                        ) ? 30 : 0;
                    
                    case 'largeStraight':
                        const largeStraights = [[1,2,3,4,5], [2,3,4,5,6]];
                        const sortedDice = [...dice].sort((a, b) => a - b);
                        return largeStraights.some(straight => 
                            straight.every((num, idx) => sortedDice[idx] === num)
                        ) ? 40 : 0;
                    
                    case 'yatzy':
                        return counts.some(count => count === 5) ? 50 : 0;
                    
                    case 'chance':
                        return dice.reduce((a, b) => a + b, 0);
                    
                    default:
                        return 0;
                }
            }

            updateGameDisplay() {
                this.isMyTurn = this.players[this.gameState.currentPlayerIndex]?.id === this.playerId;
                
                // Update current player display
                const currentPlayer = this.players[this.gameState.currentPlayerIndex];
                const currentPlayerEl = document.getElementById('currentPlayer');
                currentPlayerEl.innerHTML = `${currentPlayer?.name}'s Turn ${this.isMyTurn ? '(Your Turn!)' : ''}`;
                currentPlayerEl.className = this.isMyTurn ? 'current-player your-turn' : 'current-player';
                
                // Update dice
                this.updateDiceDisplay();
                
                // Update rolls left
                document.getElementById('rollsLeft').textContent = `Rolls left: ${this.gameState.rollsLeft}`;
                
                // Update game instructions
                const instructionsEl = document.getElementById('gameInstructions');
                if (this.isMyTurn) {
                    if (this.gameState.rollsLeft === 3) {
                        instructionsEl.textContent = 'Roll the dice to start your turn';
                    } else if (this.gameState.rollsLeft > 0) {
                        instructionsEl.textContent = 'Hold dice and roll again, or choose a category to score';
                    } else {
                        instructionsEl.textContent = 'Choose a category to score your dice';
                    }
                } else {
                    instructionsEl.textContent = `Waiting for ${currentPlayer?.name} to play...`;
                }
                
                // Update roll button
                const rollBtn = document.getElementById('rollBtn');
                rollBtn.disabled = !this.isMyTurn || this.gameState.rollsLeft <= 0;
                rollBtn.textContent = this.isMyTurn ? 'Roll Dice' : `${currentPlayer?.name} is playing...`;
                
                // Update scoreboard
                this.updateScoreboard();
            }

            updateDiceDisplay() {
                const diceContainer = document.getElementById('diceContainer');
                diceContainer.innerHTML = '';
                
                this.gameState.dice.forEach((value, index) => {
                    const die = document.createElement('div');
                    die.className = `die ${this.gameState.heldDice[index] ? 'held' : ''} ${!this.isMyTurn ? 'disabled' : ''}`;
                    die.textContent = value;
                    die.title = this.isMyTurn ? (this.gameState.heldDice[index] ? 'Click to unhold' : 'Click to hold') : '';
                    
                    if (this.isMyTurn && this.gameState.rollsLeft < 3) {
                        die.onclick = () => this.toggleHold(index);
                    }
                    
                    diceContainer.appendChild(die);
                });
            }

            animateDiceRoll() {
                const dice = document.querySelectorAll('.die');
                dice.forEach(die => {
                    if (!die.classList.contains('held')) {
                        die.classList.add('rolling');
                        setTimeout(() => die.classList.remove('rolling'), 500);
                    }
                });
            }

            updateScoreboard() {
                const scoreboard = document.getElementById('scoreboard');
                scoreboard.innerHTML = '';
                
                this.players.forEach((player, playerIndex) => {
                    const playerDiv = document.createElement('div');
                    let playerClasses = 'player-score';
                    
                    if (playerIndex === this.gameState.currentPlayerIndex) {
                        playerClasses += ' current-turn';
                    }
                    if (player.id === this.playerId) {
                        playerClasses += ' your-score';
                    }
                    if (!player.connected) {
                        playerClasses += ' disconnected';
                    }
                    
                    playerDiv.className = playerClasses;
                    
                    let html = `<h3>${player.name} (${player.totalScore} points)${!player.connected ? ' - OFFLINE' : ''}</h3>`;
                    html += '<div class="score-categories">';
                    
                    // Upper section
                    html += '<div class="section-header">Upper Section</div>';
                    ['ones', 'twos', 'threes', 'fours', 'fives', 'sixes'].forEach(cat => {
                        const isAvailable = player.scores[cat] === null && 
                                          playerIndex === this.gameState.currentPlayerIndex && 
                                          this.isMyTurn && 
                                          this.gameState.rollsLeft < 3;
                        const score = player.scores[cat] !== null ? player.scores[cat] : '-';
                        const potentialScore = isAvailable ? this.calculateScore(cat, this.gameState.dice) : '';
                        
                        html += `
                            <div class="category-name ${isAvailable ? 'available' : ''}" 
                                 ${isAvailable ? `onclick="game.scoreCategory('${cat}')" title="Click to score ${potentialScore} points"` : ''}>
                                ${this.categories[cat].name} ${potentialScore ? `(${potentialScore})` : ''}
                            </div>
                            <div class="category-score">${score}</div>
                        `;
                    });
                    
                    // Lower section
                    html += '<div class="section-header">Lower Section</div>';
                    ['threeOfKind', 'fourOfKind', 'fullHouse', 'smallStraight', 'largeStraight', 'yatzy', 'chance'].forEach(cat => {
                        const isAvailable = player.scores[cat] === null && 
                                          playerIndex === this.gameState.currentPlayerIndex && 
                                          this.isMyTurn && 
                                          this.gameState.rollsLeft < 3;
                        const score = player.scores[cat] !== null ? player.scores[cat] : '-';
                        const potentialScore = isAvailable ? this.calculateScore(cat, this.gameState.dice) : '';
                        
                        html += `
                            <div class="category-name ${isAvailable ? 'available' : ''}" 
                                 ${isAvailable ? `onclick="game.scoreCategory('${cat}')" title="Click to score ${potentialScore} points"` : ''}>
                                ${this.categories[cat].name} ${potentialScore ? `(${potentialScore})` : ''}
                            </div>
                            <div class="category-score">${score}</div>
                        `;
                    });
                    
                    html += `<div class="total-row">Total: ${player.totalScore}</div>`;
                    html += '</div>';
                    
                    playerDiv.innerHTML = html;
                    scoreboard.appendChild(playerDiv);
                });
            }

            endGame(winner, finalScores) {
                document.getElementById('winner').textContent = `🎉 ${winner.name} Wins with ${winner.totalScore} points! 🎉`;
                
                let scoresHtml = '';
                finalScores.forEach((player, index) => {
                    scoresHtml += `
                        <div class="score-item">
                            <span>${index + 1}. ${player.name}</span>
                            <span>${player.totalScore} points</span>
                        </div>
                    `;
                });
                document.getElementById('finalScores').innerHTML = scoresHtml;
                
                document.getElementById('gameOver').style.display = 'block';
                this.showNotification('Game completed!', 'success');
            }

            resetGame() {
                this.playerId = null;
                this.roomCode = null;
                this.isHost = false;
                this.isMyTurn = false;
                this.players = [];
                this.gameState = {
                    gameStarted: false,
                    currentPlayerIndex: 0,
                    dice: [1, 1, 1, 1, 1],
                    heldDice: [false, false, false, false, false],
                    rollsLeft: 3
                };
                
                document.getElementById('connectionSetup').style.display = 'block';
                document.getElementById('gameArea').style.display = 'none';
                document.getElementById('gameOver').style.display = 'none';
                document.getElementById('connectionStatus').style.display = 'none';
                document.getElementById('startGameBtn').style.display = 'none';
                
                // Reset form buttons
                const hostBtn = document.getElementById('hostBtn');
                const joinBtn = document.getElementById('joinBtn');
                hostBtn.disabled = false;
                hostBtn.classList.remove('btn-loading');
                joinBtn.disabled = false;
                joinBtn.classList.remove('btn-loading');
                
                // Clear form inputs
                document.getElementById('hostPlayerName').value = '';
                document.getElementById('joinPlayerName').value = '';
                document.getElementById('roomCode').value = '';
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
                
                // Reset loading buttons
                const hostBtn = document.getElementById('hostBtn');
                const joinBtn = document.getElementById('joinBtn');
                hostBtn.disabled = false;
                hostBtn.classList.remove('btn-loading');
                joinBtn.disabled = false;
                joinBtn.classList.remove('btn-loading');
            }

            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type} show`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // Global functions and initialization
        let game;

        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', function() {
            game = new RealTimeYatzy();
        });

        // Global functions for onclick handlers
        function hostGame() {
            game.hostGame();
        }

        function joinGame() {
            game.joinGame();
        }

        function startMultiplayerGame() {
            game.startMultiplayerGame();
        }

        function rollDice() {
            game.rollDice();
        }

        function resetGame() {
            game.resetGame();
        }

        // Utility functions
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                game.showNotification('Room code copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                game.showNotification('Room code copied!', 'success');
            });
        }

        // Service Worker for PWA capabilities (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>